# Agent Statistics Breakout UI - Plan v4 Completed

## Summary

Fixed the root cause of missing token data in the Usage Dashboard by wiring token metrics through the event chain from process exit to stats database.

---

## Problem

The TOTAL TOKENS, AVG THROUGHPUT cards and Agent Throughput chart showed no data because:

1. Token data was available in `managedProcess.lastUsageTotals` (populated by `StdoutHandler`)
2. But `ExitHandler` wasn't including it in the `query-complete` event
3. And `stats-listener` wasn't passing it to `insertQueryEvent()`

Result: `query_events.input_tokens`, `output_tokens`, and `tokens_per_second` columns were always NULL.

---

## Solution

Wire token metrics through the complete event chain:

```
StdoutHandler (extracts usage from agent JSON)
    ↓
managedProcess.lastUsageTotals (stores token counts)
    ↓
ExitHandler (computes tokensPerSecond, emits query-complete)
    ↓
stats-listener (passes to insertQueryEvent)
    ↓
query_events table (stores in database)
```

---

## Changes Made

### 1. `src/main/process-manager/types.ts`

Added token fields to `QueryCompleteData` interface:

```typescript
export interface QueryCompleteData {
  // ...existing fields...
  /** Input tokens consumed by this query (if available from agent) */
  inputTokens?: number;
  /** Output tokens generated by this query (if available from agent) */
  outputTokens?: number;
  /** Throughput in tokens per second (outputTokens / durationSeconds) */
  tokensPerSecond?: number;
}
```

### 2. `src/main/process-manager/handlers/ExitHandler.ts`

Compute and include token metrics in the `query-complete` event:

```typescript
// Compute tokens per second from lastUsageTotals (populated by StdoutHandler)
const durationSeconds = duration / 1000;
const outputTokens = managedProcess.lastUsageTotals?.outputTokens;
const inputTokens = managedProcess.lastUsageTotals?.inputTokens;
const tokensPerSecond =
  outputTokens && durationSeconds > 0 ? outputTokens / durationSeconds : undefined;

this.emitter.emit('query-complete', sessionId, {
  // ...existing fields...
  inputTokens,
  outputTokens,
  tokensPerSecond,
});
```

### 3. `src/main/process-listeners/stats-listener.ts`

Pass token fields to `insertQueryEvent()`:

```typescript
const id = db.insertQueryEvent({
  // ...existing fields...
  inputTokens: queryData.inputTokens,
  outputTokens: queryData.outputTokens,
  tokensPerSecond: queryData.tokensPerSecond,
});
```

### 4. `src/__tests__/main/stats-db.test.ts`

Updated tests:
- Parameter count expectations from 9 to 12
- Migration version expectations from 3 to 4
- Use `toMatchObject` for byDay assertions (allows additional fields)

---

## Files Modified

| File | Change |
|------|--------|
| `src/main/process-manager/types.ts` | Added token fields to `QueryCompleteData` |
| `src/main/process-manager/handlers/ExitHandler.ts` | Compute and emit token metrics |
| `src/main/process-listeners/stats-listener.ts` | Pass token fields to database |
| `src/__tests__/main/stats-db.test.ts` | Updated test expectations |

---

## Testing

| Test Suite | Result |
|------------|--------|
| `stats-db.test.ts` | 297 passed |
| `stats-listener.test.ts` | 6 passed |
| `stats.test.ts` (IPC handlers) | 22 passed |
| TypeScript build (main) | Success |
| TypeScript build (renderer) | Success |

---

## Commit

```
f5bc0b1a feat: wire token metrics through query-complete event to stats database
```

---

## Expected Behavior

After this fix:
- **New queries** will have token metrics recorded in the database
- **TOTAL TOKENS** card will show cumulative output tokens
- **AVG THROUGHPUT** card will show weighted average tokens/second
- **Agent Throughput chart** will display actual throughput values per session

**Note:** Legacy queries (recorded before this fix) will still show zeros, as their database rows have NULL token values.

---

## Status

**Completed**
